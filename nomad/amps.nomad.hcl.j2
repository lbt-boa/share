job "amps" {
  type = "service"
  constraint {
    attribute = "${meta.has.everything}"
    value = "True"
  }
  group "amps" {
    count = 1
    volume "efs" {
      type      = "host"
      source    = "efs"
      read_only = true
    }

    network {
{%- for s in services %}
{%- for svc, port in s.items() %}
      port "{{svc}}" { to = {{port}} }
{%- endfor %}
{%- endfor %}
    }

{%- for s in services -%}
{%- for svc, port in s.items() %}
    service {
      name     = "amps-{{svc}}"
      port     = "{{svc}}"
      provider = "nomad"
    }
{%- endfor %}
{%- endfor %}

    task "amps-task" {
      driver = "exec"
      # artifact {
      #   source      = "http://127.0.0.1:6666/efs/amps/AMPS-5.3.5.27-Release-Linux.tar.gz"
      # 	destination = "local/amps"
      # }
      # artifact {
      #   source      = "http:localhost:6666/efs/amps/nomad.config.xml"
      # }
      config {
        command = "efs/amps/AMPS-5.3.5.27-Release-Linux/bin/ampServer"
	args    = ["efs/amps/nomad.config.xml"]
      }

      volume_mount {
        volume      = "efs"
        destination = "efs"
        read_only = true
      }
    }
  }
}
